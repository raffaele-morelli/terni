---
title: "Terni"
output: 
  html_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

{
  library(sf)
  library(dplyr)
  library(ggplot2)
  library(chron)
  library(readxl)
  library(glue)
  library(lubridate)
  library(readr)
  library(purrr)
  library(stringr)
  library(mgcv)
  library(gratia)
} 

getSign <- function(mod) {
  summary(mod)$s.table %>% 
  as.data.frame() %>% 
  filter(`p-value` < 0.05) %>% 
  rownames() -> v_sign
  return(v_sign)
}


getModel <- function(vars) {
  ms <- 
    lapply(vars, function(x) {
      case_when(
        x == "tp_median" ~ paste0("s(", x, ", k=3)"),
        x == "u10m_min" ~ paste0("s(", x, ", k=5)"),
        x == "u10m_max" ~ paste0("s(", x, ", k=8)"),
        x == "v10m_median" ~ paste0("s(", x, ", k=9)"),
        x == "wspeed_min" ~ paste0("s(", x, ", k=8)"),
        x == "pblmin_median" ~ paste0("s(", x, ", k=3)"),
        x == "pblmin_IQR" ~ paste0("s(", x, ", k=9)"),
        x == "pbl00_min" ~ paste0("s(", x, ", k=1)"),
        x == "s7_sup_200" ~ paste0("s(", x, ", k=3)"),
        .default = paste0("s(", x, ")")
      )
    }) %>% paste(collapse = " + ") 
  
  ms <- paste("gam(log(value) ~ ", ms, ", gamma=1.4, family=gaussian(link=log), data = df)")
  
  print(ms)
  mod <- eval(parse(text = ms))
  
  return(mod)

}



  
df <- read_csv("~/R/terni/data/dataframes/df_finale_Cr_i.csv", show_col_types = FALSE)

names(df)[11] <- "value"

```

# cappa mirati

## log

```{r}

mod <- getModel(c("cold_area",  "u10m_IQR",   "bh_200",     "imp_200",    "wspeed_min"))

summary(mod)
appraise(mod)
draw(mod)

```



# no cappas

## log

```{r}
vars <- c("cold_area", "u10m_IQR",  "bh_200", "imp_200")

mod <- lapply(vars, function(x) paste0("s(", x, ")") ) %>% paste(collapse = " + ") 

ms <- paste("gam(log(value) ~ ", mod, ", gamma=1.4, family=gaussian(link=log), data = df)")

mod <- eval(parse(text = ms))

summary(mod)
appraise(mod)
draw(mod)
```

## non log


```{r}
vars <- c("cold_area", "t2m_mean",  "bh_200",    "rh_IQR")

mod <- lapply(vars, function(x) paste0("s(", x, ")") ) %>% paste(collapse = " + ") 

ms <- paste("gam(log(value) ~ ", mod, ", gamma=1.4, family=gaussian(link=log), data = df)")

mod <- eval(parse(text = ms))

summary(mod)
appraise(mod)
draw(mod)
```


# cappas

## non log 

```{r, echo=TRUE}
vars_1 <- c("pop_200",  "t2m_mean", "rh_IQR")

mod_1 <- lapply(vars_1, function(x) paste0("s(", x, ")") ) %>% paste(collapse = " + ") 

ms_1 <- paste("gam(log(value) ~ ", mod_1, ", gamma=1.4, family=gaussian(link=log), data = df)")

mod_1 <- eval(parse(text = ms_1)) 

summary(mod_1)
appraise(mod_1)
draw(mod_1)

```

## log

```{r}
vars_2 <- c("pop_200", "rh_IQR", "scrapyard", "t2m_mean", "tmin2m_IQR", "tp_max", "bh_200")

mod_2 <- lapply(vars_2, function(x) paste0("s(", x, ")") ) %>% paste(collapse = " + ") 

ms_2 <- paste("gam(log(value) ~ ", mod_2, ", gamma=1.4, family=gaussian(link=log), data = df)")

mod_2 <- eval(parse(text = ms_2))

summary(mod_2)
appraise(mod_2)
draw(mod_2)

```

